apiVersion: batch/v1
kind: Job
metadata:
  name: sab-config-fsck
  namespace: sabnzbd
  labels:
    app.kubernetes.io/name: sabnzbd
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: fsck
        image: alpine:3.20
        securityContext:
          privileged: true
        command:
        - sh
        - -c
        - |
          set -euo pipefail
          apk add --no-cache e2fsprogs xfsprogs util-linux findmnt blkid
          mount | grep " /config " || { echo "PVC not mounted at /config"; exit 1; }
          DEV="$(findmnt -n -o SOURCE /config)"
          echo "Backing device: $DEV"
          umount /config
          FSTYPE="$(blkid -o value -s TYPE "$DEV" || true)"
          echo "Filesystem type: ${FSTYPE:-unknown}"
          case "$FSTYPE" in
            ext4) e2fsck -p -y "$DEV" || true ;;
            xfs)  xfs_repair -L "$DEV" || true ;;
            *)    echo "Unsupported/unknown FS type: ${FSTYPE:-none}"; exit 1 ;;
          esac
        volumeMounts:
        - name: cfg
          mountPath: /config
      volumes:
      - name: cfg
        persistentVolumeClaim:
          # <<< IMPORTANT: set this to your SAB /config PVC name >>>
          claimName: sabnzbd-config
